<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8">
  <title>作品讀取中...</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
  <!-- 新增 favicon -->
  <link rel="icon" href="https://res.cloudinary.com/dijzndzw2/image/upload/v1757176751/logo-3_hddq08.png" type="image/png"/>
  <style>
    :root { --max-w: 1120px; --fg:#0d0d0d; --muted:#666; --bg:#fff; --brand:#111827; --radius: 14px; }
    *{ box-sizing:border-box }
    html, body { margin:0; padding:0; font-family: 'Noto Sans TC', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color: var(--fg); background: var(--bg); }
    a { color: inherit; text-decoration: none }
    img { max-width: 100%; display:block; height:auto }
    .container { max-width: var(--max-w); margin: 0 auto; padding: 0 20px; }
    header { position: sticky; top:0; z-index:10; backdrop-filter: saturate(180%) blur(10px); background: rgba(255,255,255,.85); border-bottom:1px solid #eee; }
    .nav { display:flex; align-items:center; justify-content:space-between; height:64px; }
    .logo { display:flex; align-items:center; gap:10px; font-weight:800 }
    .logo img { height:40px; width:auto; max-height:40px; max-width:none; object-fit:contain; border-radius:6px }
    main { padding:28px 0 60px }
    .title { font-size: clamp(22px, 4vw, 36px); margin: 8px 0 8px; font-weight:800 }
    .muted { color:var(--muted); font-size:14px }
    .tags { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
    .tag { font-size:12px; padding:4px 8px; border-radius:999px; background:#f3f4f6; border:1px solid #eee }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top:16px }
    .btn { padding:10px 14px; border-radius:10px; background:var(--brand); color:#fff; font-weight:700; border:0 }
    .ghost { padding:10px 14px; border-radius:10px; border:1px solid #ddd; background:#fff }
    .desc { margin-top:14px; line-height:1.7; color:#333 }
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap:20px; margin-top:24px }
    .card { grid-column: span 12; border:1px solid #eee; border-radius: var(--radius); overflow:hidden; background:#fff; }
    .cap { padding:10px 12px; font-size:14px; color:#444; border-top:1px solid #f0f0f0 }
    .meta { display:flex; align-items:center; gap:8px; color:#777; font-size:14px }
    @media (min-width: 900px){ .card{ grid-column: span 6 } }
  </style>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>
  <header>
    <div class="container nav">
      <div class="logo" href="index.html">
        <img src="logo.png">
      </div>
      <a class="ghost" href="gallery.html">回到清單</a>
    </div>
  </header>

  <main class="container" id="main">
    <h1 class="title" id="title">載入中…</h1>
    <div class="meta"><span id="date"></span><span id="slug" class="muted"></span></div>
    <div class="tags" id="tags"></div>
    <div class="desc" id="desc"></div>
    <div class="actions">
      <a id="zip" class="ghost" href="#">下載 ZIP</a>
<a id="share" class="ghost" href="#" target="_blank" rel="noopener">連結分享</a>
    </div>

    <section class="grid" id="images"></section>
  </main>

  <script>
function setText(id, text){ var el = qsel(id); if (el) el.textContent = text; }
function setHTML(id, html){ var el = qsel(id); if (el) el.innerHTML = html; }
function clearHTML(id){ var el = qsel(id); if (el) el.innerHTML = ''; }

// Utilities
function qsel(id){ return document.getElementById(id); }
function getSlug(){ return (new URL(location.href)).searchParams.get('slug') || ''; }

// Lightbox
let LB_IMAGES = []; let LB_INDEX = 0;
function initLightbox(images){
  LB_IMAGES = Array.isArray(images) ? images.slice() : [];
  const overlay = qsel('lightbox-overlay');
  const img = qsel('lb-img');
  const cap = qsel('lb-cap');
  const count = qsel('lb-count');
  const closeBtn = qsel('lb-close');
  const prevBtn = qsel('lb-prev');
  const nextBtn = qsel('lb-next');

  function update(){
    const it = LB_IMAGES[LB_INDEX] || {};
    img.src = it.url || '';
    img.alt = it.alt || '';
    cap.textContent = it.caption || it.alt || '';
    count.textContent = (LB_INDEX+1) + ' / ' + LB_IMAGES.length;
  }
  window.openLightbox = function(i){
    if (!LB_IMAGES.length) return;
    LB_INDEX = Math.max(0, Math.min(i|0, LB_IMAGES.length-1));
    update();
    overlay.style.display = 'flex';
  };
  function close(){ overlay.style.display = 'none'; }
  function prev(){ if (LB_IMAGES.length){ LB_INDEX = (LB_INDEX - 1 + LB_IMAGES.length) % LB_IMAGES.length; update(); } }
  function next(){ if (LB_IMAGES.length){ LB_INDEX = (LB_INDEX + 1) % LB_IMAGES.length; update(); } }

  if (closeBtn) closeBtn.onclick = close;
  if (prevBtn) prevBtn.onclick = prev;
  if (nextBtn) nextBtn.onclick = next;
  overlay.addEventListener('click', function(e){
    const dialog = qsel('lb-dialog');
    if (e.target === overlay || (dialog && !dialog.contains(e.target))) close();
  });
  document.addEventListener('keydown', function(e){
    if (overlay.style.display === 'flex'){
      if (e.key === 'Escape') close();
      if (e.key === 'ArrowLeft') prev();
      if (e.key === 'ArrowRight') next();
    }
  });
}

// Render
function render(slug, data){
  // meta
  document.title = (data.title ? data.title + '｜' : '') + '作品詳情';
  if (qsel('title')) setText('title', data.title || slug);
  if (qsel('slug')) setText('slug', ' / ' + slug);
  const d = new Date(data.date || data.created_at || Date.now());
  if (qsel('date')) setText('date', d.toLocaleDateString('zh-TW'));

  // tags
  const tagsWrap = qsel('tags'); if (tagsWrap) tagsWrap.innerHTML = '';
  const tagsArr = Array.isArray(data.tags) ? data.tags
                : (data.tags ? String(data.tags).split(/[, \s]+/).map(s=>s.trim()).filter(Boolean) : []);
  for (const t of tagsArr){
    const el = document.createElement('span'); el.className = 'tag'; el.textContent = t;
    tagsWrap && tagsWrap.appendChild(el);
  }

  // images
  const images = Array.isArray(data.items) ? data.items : (data.items ? [data.items] : []);
  const normalized = images.map(x => ({
    url: x.url || x.src || '',
    alt: x.alt || x.caption || '',
    caption: x.caption || ''
  })).filter(x => x.url);

  initLightbox(normalized);

  const first = qsel('share');
if (first){
  first.textContent = '連結分享';
  first.href = '#';
  first.removeAttribute('target'); first.removeAttribute('rel');
  const onShare = async function(e){
    e.preventDefault(); e.stopImmediatePropagation();
    const shareUrl = location.href;
    const title = (qsel('title') && qsel('title').textContent) || document.title || '分享';
    try{
      if (navigator.share){ await navigator.share({ title, url: shareUrl }); }
      else if (navigator.clipboard && navigator.clipboard.writeText){ await navigator.clipboard.writeText(shareUrl); alert('已複製分享連結'); }
      else { prompt('複製此連結：', shareUrl); }
    }catch(_){}
  };
  const clone = first.cloneNode(true);
  first.parentNode.replaceChild(clone, first);
  clone.addEventListener('click', onShare, true);
}

  const grid = qsel('images'); if (grid) grid.innerHTML = '';
  for (let i = 0; i < normalized.length; i++){
    const it = normalized[i];
    const card = document.createElement('article'); card.className = 'card';
    const link = document.createElement('a'); link.href = it.url; link.addEventListener('click', function(e){ e.preventDefault(); openLightbox(i); });
    const img = document.createElement('img'); img.loading = 'lazy'; img.alt = it.alt || ''; img.src = it.url;
    link.appendChild(img); card.appendChild(link);
    const cap = document.createElement('div'); cap.className = 'cap'; cap.textContent = it.caption || it.alt || '';
    card.appendChild(cap);
    if (grid) grid.appendChild(card);
  }

  // zip link
  try{
    var z = qsel('zip');
    if (z) {
      z.href = `/.netlify/functions/zip-images?slug=${encodeURIComponent(slug)}`;
      z.setAttribute('download','');
      z.onclick = null;
      z.removeAttribute('target'); z.removeAttribute('rel');
    }
  }catch(_){}
}

// Load
async function load(){
  const slug = getSlug();
  try{
    const res = await fetch(`/.netlify/functions/get-post?slug=${encodeURIComponent(slug)}`);
    if (!res.ok) throw new Error('載入作品失敗');
    const data = await res.json();
    render(slug, data);
  }catch(e){
    if (qsel('title')) setText('title', e.message || e);
  }
}

load();

</script>
<div id="lightbox-overlay" style="position:fixed;inset:0;background:rgba(0,0,0,.9);display:none;align-items:center;justify-content:center;z-index:1000;">
    <button id="lb-close" aria-label="關閉" style="position:absolute;top:8px;right:8px;padding:12px 14px;border:1px solid #666;background:#111;color:#fff;border-radius:12px;cursor:pointer;font-weight:800;font-size:16px;z-index:1001">✕</button>
    <div id="lb-dialog" style="position:relative;max-width:94vw;max-height:92vh;display:flex;flex-direction:column;align-items:center;">
      <figure style="max-width:94vw;max-height:84vh;margin:0;text-align:center">
        <img id="lb-img" alt="" style="max-width:94vw;max-height:72vh;border-radius:12px;display:block;margin:0 auto" />
        <figcaption id="lb-cap" style="color:#ddd;font-size:16px;margin-top:10px"></figcaption>
        <div id="lb-count" style="color:#bbb;font-size:13px;margin-top:4px"></div>
      </figure>
      <div id="lb-bar" style="margin-top:10px;gap:12px">
        <button id="lb-prev" aria-label="上一張" style="padding:12px 16px;border:1px solid #666;background:#111;color:#fff;border-radius:12px;cursor:pointer;font-weight:800;font-size:18px">⟨ 上一張</button>
        <button id="lb-next" aria-label="下一張" style="padding:12px 16px;border:1px solid #666;background:#111;color:#fff;border-radius:12px;cursor:pointer;font-weight:800;font-size:18px">下一張 ⟩</button>
      </div>
    </div>
  </div></body>
</html>
